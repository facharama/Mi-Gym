{% extends "base.html" %}
{% load static %}

{% block navbar %}
  {% include "partials/nav_home.html" %}
{% endblock %}

{% block extra_css %}
  {# Tus estilos existentes #}
  <link rel="stylesheet" href="{% static 'css/nav_home.css' %}">
  <link rel="stylesheet" href="{% static 'css/sidebar_admin.css' %}">
{% endblock %}

{% block content %}
  {# Sidebar permanente a la izquierda #}
  {% include "partials/sidebar_admin.html" %}

  {# Sumamos utilidades Bootstrap sin tocar tu layout #}
  <div class="dash-container container-fluid py-4">
    {% block page_content %}{% endblock %}
  </div>
{% endblock %}

{% block extra_js %}

  {# Activamos el tema 'migym' (si tu base.html no lo setea) #}
  <script>document.documentElement.setAttribute('data-bs-theme','migym');</script>

  <script>
  /* === Sidebar: colapsar/expandir y submenús === */
  document.addEventListener("DOMContentLoaded", () => {
    const body = document.body;
    const toggle = document.getElementById("sidebar-toggle");
    const groupToggles = document.querySelectorAll(".ls-group-toggle");

    // Arranca colapsado
    body.classList.add("sidebar-collapsed");

    if (toggle) {
      toggle.addEventListener("click", () => {
        body.classList.toggle("sidebar-collapsed");
      });
    }

    groupToggles.forEach(btn => {
      btn.addEventListener("click", () => btn.parentElement.classList.toggle("open"));
    });
  });
  </script>

  <script>
  /* === Mini panel: selector de sucursal + ocupación en vivo === */
  (function(){
    const OCC_URL = "{% url 'ocupacion:occupancy_current' %}";
    const sel    = document.getElementById('occ-sel');
    const elCnt  = document.getElementById('occ-count');
    const elCap  = document.getElementById('occ-capacity');
    const elBar  = document.getElementById('occ-bar');
    const elName = document.getElementById('occ-sucursal-name');
    if (!sel || !elCnt || !elCap || !elBar || !elName) return;

    function nombreSeleccionado(){
      return sel && sel.options.length ? sel.options[sel.selectedIndex].text.trim() : "";
    }

    async function refresh(){
      const suc = sel && sel.value ? sel.value : '';
      const url = suc ? `${OCC_URL}?sucursal_id=${encodeURIComponent(suc)}` : OCC_URL;

      try{
        const r = await fetch(url, { headers: { 'Accept': 'application/json' }});
        const data = await r.json();
        const count    = Number(data.count ?? 0);
        const capacity = Number(data.capacity ?? 0);
        const pct      = capacity > 0 ? Math.round((count / capacity) * 100) : 0;

        elCnt.textContent  = count;
        elCap.textContent  = capacity > 0 ? capacity : '—';
        elBar.style.width  = pct + '%';
        elName.textContent = nombreSeleccionado();

        if (window.miGymRefreshOcc) window.miGymRefreshOcc();
      }catch(e){
        console.error(e);
      }
    }

    sel.addEventListener('change', refresh);
    refresh();
    setInterval(refresh, 5000);
  })();
  </script>
{% endblock %}
